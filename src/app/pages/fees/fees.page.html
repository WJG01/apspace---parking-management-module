<ion-header>
  <ion-toolbar mode="md">
    <ion-title>Fees</ion-title>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/"></ion-back-button>
    </ion-buttons>
    <ion-buttons @buttonEnterOut slot="secondary" *ngIf="selectedSegment === 'Details'" slot="end">
      <ion-button (click)="openFilterMenu()">
        <ion-icon slot="icon-only" name="options"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar *ngIf="(bankDraft$ | async) as bankDrafts; else loadingSegment">
    <ion-segment [(ngModel)]="selectedSegment" (ngModelChange)="segmentValueChanged()">
      <ion-segment-button value="Summary">Summary</ion-segment-button>
      <ion-segment-button *ngIf="bankDrafts[0].BANKDRAFT_AMOUNT !== 0" value="Bank Draft">
        SU Fees
      </ion-segment-button>
      <ion-segment-button value="Details">Details</ion-segment-button>
    </ion-segment>
  </ion-toolbar>

  <ng-template #loadingSegment>
    <ion-toolbar>
      <ion-grid>
        <ion-row class="ion-justify-content-center">
          <ion-col class="ion-padding-horizontal" size="12" size-md="6" size-lg="4">
            <ion-item lines="none">
              <ion-skeleton-text style="width: 100%; height: 38px;" animated></ion-skeleton-text>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-toolbar>
  </ng-template>

</ion-header>

<ion-menu menuId="filter-menu" contentId="fee-content" side="end" type="overlay">
  <ion-header>
    <ion-toolbar>
      <ion-title>Filter Details</ion-title>
    </ion-toolbar>
  </ion-header>
  <ion-content>
    <ion-list>
      <ion-item *ngFor="let label of labels; let label_index = index;"
        (click)="updateChartLabelVisibility(label_index, label.visible)">
        <ion-label>{{ label.name }}</ion-label>
        <ion-checkbox [(ngModel)]="label.visible">
        </ion-checkbox>
      </ion-item>
    </ion-list>
  </ion-content>
</ion-menu>

<ion-content id="fee-content" #content>
  <!-- refresher -->
  <ion-refresher slot="fixed" pullMax="400" pullMin="60" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content refreshing-spinner="dots" pullingIcon="refresh"></ion-refresher-content>
  </ion-refresher>

  <div class="glob-container">
    <ion-grid>
      <ion-row>
        <ion-col size-xs="12" size-md="7">
          <ng-template let-totalSummary [ngIf]="totalSummary$ | async" [ngIfElse]="loadingTotalSummary">
            <ion-card class="content-card" #total_summary_card [ngClass]="{
            'green-total-summary-card': (totalSummary[0].TOTAL_PAYABLE === totalSummary[0].TOTAL_PAID),
            'yellow-total-summary-card': (totalSummary[0].TOTAL_OUTSTANDING > 0),
            'pink-total-summary-card': (totalSummary[0].FINE > 0),
            'red-total-summary-card': (totalSummary[0].TOTAL_OVERDUE > 0)
          }">
              <ion-card-header>
                <ion-card-title class="ion-text-center">Total Summary</ion-card-title>
              </ion-card-header>

              <ion-card-content>
                <chart #financialsChartComponent *ngIf="financialsChart.data" [type]="financialsChart.type"
                  [data]="financialsChart.data" [options]="financialsChart.options">
                </chart>
                <ion-item class="glob-text-bold green-text" lines="none">
                  <ion-label>
                    <h3>Total Payable</h3>
                  </ion-label>
                  <ion-note slot="end">{{ (totalSummary[0]?.TOTAL_PAYABLE || 0) | currency:'MYR':'RM' }}
                  </ion-note>
                </ion-item>
                <ion-item class="glob-text-bold green-text" lines="none">
                  <ion-label>
                    <h3>Total Paid</h3>
                  </ion-label>
                  <ion-note slot="end">{{ (totalSummary[0]?.TOTAL_PAID || 0) | currency:'MYR':'RM' }}</ion-note>
                </ion-item>
                <ion-item class="glob-text-bold yellow-text" lines="none">
                  <ion-label>
                    <h3>Total Outstanding</h3>
                  </ion-label>
                  <ion-note slot="end">{{ (totalSummary[0]?.TOTAL_OUTSTANDING || 0) | currency:'MYR':'RM' }}
                  </ion-note>
                </ion-item>
                <ion-item class="glob-text-bold red-text" lines="none">
                  <ion-label>
                    <h3>Total Overdue</h3>
                  </ion-label>
                  <ion-note slot="end">{{ (totalSummary[0]?.TOTAL_OVERDUE || 0) | currency:'MYR':'RM' }}
                  </ion-note>
                </ion-item>
                <ion-item class="glob-text-bold pink-text" lines="none">
                  <ion-label>
                    <h3>Fine</h3>
                  </ion-label>
                  <ion-note slot="end">{{ (totalSummary[0]?.FINE || 0) | currency:'MYR':'RM' }}</ion-note>
                </ion-item>
              </ion-card-content>
            </ion-card>
          </ng-template>

          <ng-template #loadingTotalSummary>
            <ion-card class="content-card">
              <ion-card-header>
                <ion-skeleton-text class="glob-margin-auto" style="width: 50%; height: 20px" animated>
                </ion-skeleton-text>
              </ion-card-header>

              <ion-card-content>
                <ion-item lines="none">
                  <ion-skeleton-text class="glob-margin-auto"
                    style="width: 90%; height: 120px; padding-bottom: 10px; padding-top: 5px" animated>
                  </ion-skeleton-text>
                </ion-item>
                <ion-item lines="none">
                  <ion-skeleton-text style="width: 28%; height: 15px;" animated></ion-skeleton-text>
                  <ion-skeleton-text slot="end" style="width: 15%; height: 15px;" animated></ion-skeleton-text>
                </ion-item>
                <ion-item lines="none">
                  <ion-skeleton-text style="width: 26%; height: 15px;" animated></ion-skeleton-text>
                  <ion-skeleton-text slot="end" style="width: 15%; height: 15px;" animated></ion-skeleton-text>
                </ion-item>
                <ion-item lines="none">
                  <ion-skeleton-text style="width: 30%; height: 15px;" animated></ion-skeleton-text>
                  <ion-skeleton-text slot="end" style="width: 10%; height: 15px;" animated></ion-skeleton-text>
                </ion-item>
                <ion-item lines="none">
                  <ion-skeleton-text style="width: 28%; height: 15px;" animated></ion-skeleton-text>
                  <ion-skeleton-text slot="end" style="width: 10%; height: 15px;" animated></ion-skeleton-text>
                </ion-item>
                <ion-item lines="none">
                  <ion-skeleton-text style="width: 15%; height: 15px;" animated></ion-skeleton-text>
                  <ion-skeleton-text slot="end" style="width: 10%; height: 15px;" animated></ion-skeleton-text>
                </ion-item>
              </ion-card-content>
            </ion-card>
          </ng-template>
        </ion-col>

        <ion-col size-xs="12" size-md="5">
          <ng-container [ngSwitch]='selectedSegment'>
            <ng-container *ngSwitchCase="'Summary'">
              <ng-template let-summaries [ngIf]="summary$ | async" [ngIfElse]="loadingSummary">
                <ion-card class="content-card" *ngFor="let summary of summaries">
                  <ion-card-header>
                    <ion-card-subtitle>{{ summary.INVOICE_DESCRIPTION }}</ion-card-subtitle>
                  </ion-card-header>

                  <ion-card-content class="ion-no-padding">
                    <ion-item lines="none">
                      <ion-label>
                        <h3>Due Date</h3>
                      </ion-label>
                      <ion-note color="text-color" slot="end">
                        {{ summary.PAYMENT_DUE_DATE ? (summary.PAYMENT_DUE_DATE | dateWithTimezone: "EEE, d MMM y") : 'N/A'   }}
                      </ion-note>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-label>
                        <h3>Amount Payable</h3>
                      </ion-label>
                      <ion-note color="text-color" slot="end">
                        {{ (summary.PAYABLE_AMOUNT | currency:'MYR':'RM') || 'N/A' }}
                      </ion-note>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-label>
                        <h3>Total Collected</h3>
                      </ion-label>
                      <ion-note color="text-color" slot="end">
                        {{ (summary.TOTAL_COLLECTED | currency:'MYR':'RM') || 'N/A' }}
                      </ion-note>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-label>
                        <h3>Outstanding</h3>
                      </ion-label>
                      <ion-note color="text-color" slot="end">
                        {{ (summary.OUTSTANDING | currency:'MYR':'RM') || 'N/A' }}
                      </ion-note>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-label>
                        <h3>Fine</h3>
                      </ion-label>
                      <ion-note color="text-color" slot="end">
                        {{ (summary.FINE | currency:'MYR':'RM') || 'N/A' }}
                      </ion-note>
                    </ion-item>
                  </ion-card-content>
                </ion-card>
              </ng-template>

              <ng-template #loadingSummary>
                <ion-card class="content-card">
                  <ion-card-header>
                    <ion-card-subtitle>
                      <ion-skeleton-text style="width: 70%; height: 15px" animated></ion-skeleton-text>
                    </ion-card-subtitle>
                  </ion-card-header>
                  <ion-card-content>
                    <ion-item lines="none">
                      <ion-skeleton-text style="width: 20%; height: 15px" animated></ion-skeleton-text>
                      <ion-skeleton-text slot="end" style="width: 25%; height: 15px" animated></ion-skeleton-text>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-skeleton-text style="width: 30%; height: 15px" animated></ion-skeleton-text>
                      <ion-skeleton-text slot="end" style="width: 10%; height: 15px" animated></ion-skeleton-text>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-skeleton-text style="width: 28%; height: 15px" animated></ion-skeleton-text>
                      <ion-skeleton-text slot="end" style="width: 10%; height: 15px" animated></ion-skeleton-text>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-skeleton-text style="width: 26%; height: 15px" animated></ion-skeleton-text>
                      <ion-skeleton-text slot="end" style="width: 10%; height: 15px" animated></ion-skeleton-text>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-skeleton-text style="width: 24%; height: 15px" animated></ion-skeleton-text>
                      <ion-skeleton-text slot="end" style="width: 10%; height: 15px" animated></ion-skeleton-text>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-skeleton-text style="width: 17%; height: 15px" animated></ion-skeleton-text>
                      <ion-skeleton-text slot="end" style="width: 10%; height: 15px" animated></ion-skeleton-text>
                    </ion-item>
                  </ion-card-content>
                </ion-card>
              </ng-template>
            </ng-container>

            <ng-container *ngSwitchCase="'Bank Draft'">
              <ng-template let-bankDrafts [ngIf]="bankDraft$ | async" [ngIfElse]="loadingBankDraft">
                <ion-card class="content-card" *ngFor="let bankDraft of bankDrafts">
                  <ion-list-header>
                    <ion-label>{{ bankDraft.COURSE_CODE || 'Course Code' }}</ion-label>
                  </ion-list-header>
                  <ion-card-content class="ion-no-padding">
                    <ion-item lines="none">
                      Amount Payable
                      <ion-note color="text-color" slot="end">
                        {{ bankDraft.BANKDRAFT_AMOUNT | currency:'GBP' }}
                      </ion-note>
                    </ion-item>
                    <ion-item lines="none">
                      Due Date
                      <ion-note color="text-color" slot="end">
                        {{ bankDraft.BANKDRAFT_DUE_DATE | dateWithTimezone: "EEE, d MMM y"  }}
                      </ion-note>
                    </ion-item>
                    <ion-item lines="none">
                      Date Collected
                      <ion-note color="text-color" slot="end">
                        {{ bankDraft.DATE_COLLECTED | dateWithTimezone: "EEE, d MMM y"  }}
                      </ion-note>
                    </ion-item>
                    <ion-item lines="none">
                      Registration Date
                      <ion-note color="text-color" slot="end">
                        {{ bankDraft.REGISTRATION_DATE | dateWithTimezone: "EEE, d MMM y"  }}
                      </ion-note>
                    </ion-item>
                    <ion-item lines="none">
                      Amount Collected
                      <ion-note color="success" slot="end">
                        {{ bankDraft.AMOUNT_COLLECTED | currency:'GBP' }}
                      </ion-note>
                    </ion-item>
                  </ion-card-content>
                </ion-card>
              </ng-template>

              <ng-template #loadingBankDraft>
                <ion-card class="content-card">
                  <ion-card-header>
                    <ion-card-subtitle>
                      <ion-skeleton-text style="width: 70%; height: 15px" animated></ion-skeleton-text>
                    </ion-card-subtitle>
                  </ion-card-header>
                  <ion-card-content>
                    <ion-item lines="none">
                      <ion-skeleton-text style="width: 20%; height: 15px" animated></ion-skeleton-text>
                      <ion-skeleton-text slot="end" style="width: 25%; height: 15px" animated></ion-skeleton-text>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-skeleton-text style="width: 30%; height: 15px" animated></ion-skeleton-text>
                      <ion-skeleton-text slot="end" style="width: 10%; height: 15px" animated></ion-skeleton-text>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-skeleton-text style="width: 28%; height: 15px" animated></ion-skeleton-text>
                      <ion-skeleton-text slot="end" style="width: 10%; height: 15px" animated></ion-skeleton-text>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-skeleton-text style="width: 26%; height: 15px" animated></ion-skeleton-text>
                      <ion-skeleton-text slot="end" style="width: 10%; height: 15px" animated></ion-skeleton-text>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-skeleton-text style="width: 24%; height: 15px" animated></ion-skeleton-text>
                      <ion-skeleton-text slot="end" style="width: 10%; height: 15px" animated></ion-skeleton-text>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-skeleton-text style="width: 17%; height: 15px" animated></ion-skeleton-text>
                      <ion-skeleton-text slot="end" style="width: 10%; height: 15px" animated></ion-skeleton-text>
                    </ion-item>
                  </ion-card-content>
                </ion-card>
              </ng-template>
            </ng-container>

            <ng-container *ngSwitchCase="'Details'">
              <ion-row>
                <ion-searchbar [(ngModel)]="searchTerm" placeholder="Payment title, due date, amount paid.."
                  showCancelButton="focus">
                </ion-searchbar>
              </ion-row>
              <ng-template let-details [ngIf]="detail$ | async" [ngIfElse]="loadingDetails">
                <div *ngIf="(details | fuse:searchTerm:optionsDetails).length > 0; else notFound">
                  <ion-card class="content-card"
                    *ngFor="let detail of (details | reverse | filter: visibleLabels | fuse:searchTerm:optionsDetails)">
                    <ion-card-header>
                      <ion-card-subtitle>{{ detail.ITEM_DESCRIPTION }}</ion-card-subtitle>
                    </ion-card-header>

                    <ion-card-content class="ion-no-padding">
                      <ion-item lines="none">
                        <h3>Due Date</h3>
                        <ion-note color="text-color" slot="end">
                          {{ detail.DUE_DATE | dateWithTimezone: "EEE, d MMM y" }}
                        </ion-note>
                      </ion-item>
                      <ion-item lines="none">
                        <ion-label>
                          <h3>Amount Payable</h3>
                        </ion-label>
                        <ion-note color="text-color" slot="end">
                          {{ isNumber(detail.AMOUNT_PAYABLE)
                                          ? (detail.AMOUNT_PAYABLE | currency:'MYR':'RM')
                                          : detail.AMOUNT_PAYABLE }}
                        </ion-note>
                      </ion-item>
                      <ion-item lines="none">
                        <ion-label>
                          <h3>Total Collected</h3>
                        </ion-label>
                        <ion-note slot="end">
                          {{ isNumber(detail.TOTAL_COLLECTED)
                                          ? (detail.TOTAL_COLLECTED | currency:'MYR':'RM')
                                          : detail.TOTAL_COLLECTED }}
                        </ion-note>
                      </ion-item>
                      <ion-item [style.color]="detail.OUTSTANDING>0 ? '#d50000': ''" lines="none">
                        <ion-label>
                          <h3>Outstanding</h3>
                        </ion-label>
                        <ion-note [style.color]="detail.OUTSTANDING>0 ? '#d50000': ''" slot="end">
                          {{ isNumber(detail.OUTSTANDING)
                                          ? (detail.OUTSTANDING | currency:'MYR':'RM')
                                          : detail.OUTSTANDING }}
                        </ion-note>
                      </ion-item>
                      <ion-item [style.color]="detail.FINE>0 ? '#c51162': ''" lines="none">
                        <ion-label>
                          <h3>Fine</h3>
                        </ion-label>
                        <ion-note [style.color]="detail.FINE>0 ? '#c51162': ''" slot="end">
                          {{ isNumber(detail.FINE)
                                          ? (detail.FINE | currency:'MYR':'RM')
                                          : detail.FINE }}
                        </ion-note>
                      </ion-item>
                    </ion-card-content>
                  </ion-card>
                </div>
              </ng-template>

              <ng-template #notFound>
                <app-message-with-svg imageUrl="assets/img/search-not-found.svg" messageTitle="Opps! Item not found."
                  messageContent="Perhaps you can try this:" wrapperSize="4" wrapperMarginTop="30px" wrapperOffset="4"
                  [advancedMode]="true">
                  <div class="flex-container">
                    <ul class="list-txt-color">
                      <li>Make sure the keyword is matched with one of the items</li>
                      <li>Make sure you have typed a valid item code.</li>
                      <li>Make sure there is no special characters included.</li>
                    </ul>

                    <p>Still having trouble? No worries! Just click <a [routerLink]="'/feedback'">here</a> and report to
                      us for this issue.</p>
                  </div>
                </app-message-with-svg>
              </ng-template>

              <ng-template #loadingDetails>
                <ion-card class="content-card" *ngFor="let _ of numberOfSkeletons">
                  <ion-card-header>
                    <ion-card-subtitle>
                      <ion-skeleton-text style="width: 70%; height: 15px" animated></ion-skeleton-text>
                    </ion-card-subtitle>
                  </ion-card-header>
                  <ion-card-content>
                    <ion-item lines="none">
                      <ion-skeleton-text style="width: 20%; height: 15px" animated></ion-skeleton-text>
                      <ion-skeleton-text slot="end" style="width: 25%; height: 15px" animated></ion-skeleton-text>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-skeleton-text style="width: 30%; height: 15px" animated></ion-skeleton-text>
                      <ion-skeleton-text slot="end" style="width: 10%; height: 15px" animated></ion-skeleton-text>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-skeleton-text style="width: 28%; height: 15px" animated></ion-skeleton-text>
                      <ion-skeleton-text slot="end" style="width: 10%; height: 15px" animated></ion-skeleton-text>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-skeleton-text style="width: 26%; height: 15px" animated></ion-skeleton-text>
                      <ion-skeleton-text slot="end" style="width: 10%; height: 15px" animated></ion-skeleton-text>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-skeleton-text style="width: 24%; height: 15px" animated></ion-skeleton-text>
                      <ion-skeleton-text slot="end" style="width: 10%; height: 15px" animated></ion-skeleton-text>
                    </ion-item>
                    <ion-item lines="none">
                      <ion-skeleton-text style="width: 17%; height: 15px" animated></ion-skeleton-text>
                      <ion-skeleton-text slot="end" style="width: 10%; height: 15px" animated></ion-skeleton-text>
                    </ion-item>
                  </ion-card-content>
                </ion-card>
              </ng-template>
            </ng-container>
          </ng-container>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>
</ion-content>